<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard — Kelompok Online (Tema Biru)</title>

  <!-- Socket.io -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <style>
    :root{
      --primary:#3B82F6;    /* biru utama */
      --primary-700:#1E3A8A;/* biru gelap */
      --bg-soft:#E0E7FF;    /* latar lembut */
      --card-bg: #FFFFFF;
      --muted:#6b7280;
      --glass: rgba(255,255,255,0.6);
      --radius:12px;
      --shadow: 0 6px 18px rgba(30,58,138,0.08);
    }

    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial; margin:0; background:linear-gradient(180deg,var(--bg-soft),#fff 40%); color:#0f172a}

    /* layout */
    .app{display:flex; min-height:100vh}

    /* sidebar */
    .sidebar{width:260px; background:linear-gradient(180deg,var(--primary),var(--primary-700)); color:white; padding:24px; display:flex; flex-direction:column; gap:18px}
    .brand{font-weight:700; font-size:18px}
    .nav{display:flex; flex-direction:column; gap:8px}
    .nav button{background:transparent; border:0; color:rgba(255,255,255,0.9); text-align:left; padding:8px 12px; border-radius:8px; cursor:pointer}
    .nav button.active, .nav button:hover{background:rgba(255,255,255,0.08)}

    /* main */
    .main{flex:1; padding:28px}
    .header{display:flex; justify-content:space-between; align-items:center; gap:12px}
    .title{font-size:20px; font-weight:700}
    .controls{display:flex; gap:10px; align-items:center}
    .btn{background:var(--primary); color:white; border:0; padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn.ghost{background:transparent; color:var(--primary-700); border:1px solid rgba(30,58,138,0.12)}

    /* cards */
    .grid{display:grid; grid-template-columns:repeat(4,1fr); gap:16px; margin-top:18px}
    .card{background:var(--card-bg); padding:16px; border-radius:var(--radius); box-shadow:var(--shadow)}
    .card h4{margin:0; font-size:13px; color:var(--muted)}
    .card p{margin:8px 0 0; font-size:22px; font-weight:700}

    /* content area */
    .panel{display:flex; gap:16px; margin-top:20px}
    .panel-left{flex:2}
    .panel-right{flex:1}

    /* table */
    table{width:100%; border-collapse:collapse}
    th, td{padding:10px 12px; text-align:left; border-bottom:1px solid rgba(15,23,42,0.06)}
    th{font-size:13px; color:var(--muted)}
    .status-pill{padding:6px 10px; border-radius:999px; font-size:13px; display:inline-block}
    .pill-full{background:#fee2e2; color:#b91c1c}
    .pill-ok{background:#ecfeff; color:#065f46}

    /* form */
    .form-row{display:flex; gap:8px; align-items:center}
    .input, input[type=number], select, textarea{padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06)}

    /* small helper */
    .muted{color:var(--muted); font-size:13px}

    /* members list */
    .members { margin:8px 0 0; padding-left:18px; }
    .members li { margin-bottom:6px; display:flex; align-items:center; gap:8px; justify-content:space-between; max-width:100% }
    .member-name { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1 }

    .member-remove { background:#ef4444; color:white; border:0; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:13px }

    /* chart */
    .chart-box{height:220px}

    /* responsive */
    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(2,1fr)}
      .sidebar{display:none}
      .main{padding:16px}
      .panel{flex-direction:column}
    }

    @media (max-width:600px){
      .grid{grid-template-columns:repeat(1,1fr)}
    }

    footer{margin-top:18px; color:var(--muted); font-size:13px}
  </style>
</head>
<body>
  <div class="app">

    <aside class="sidebar">
      <div class="brand">Kelompok Online — Admin</div>
      <div style="font-size:13px; opacity:0.95">Tema: Biru • Realtime</div>

      <nav class="nav">
        <button class="active" onclick="show('dashboard')">Dashboard</button>
        <button onclick="show('setup')">Pengaturan</button>
        <button onclick="show('logs')">Log Aktivitas</button>
      </nav>

      <div style="margin-top:auto; font-size:13px; opacity:0.9">Server: <span id="serverStatus">offline</span></div>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <div class="title">Panel Admin — Kelompok Online</div>
          <div style="font-size:13px; color:var(--muted)">Kelola kelompok, kapasitas, keluarkan / pindahkan anggota, dan pantau pembagian realtime</div>
        </div>

        <div class="controls">
          <label style="font-size:13px; color:var(--muted)">Theme</label>
          <button class="btn ghost" onclick="toggleTheme()">Toggle Mode</button>
          <button class="btn" onclick="resetMembers()">Reset Anggota</button>
        </div>
      </div>

      <!-- cards -->
      <div class="grid">
        <div class="card">
          <h4>Total Anggota</h4>
          <p id="totalMembers">0</p>
        </div>
        <div class="card">
          <h4>Jumlah Kelompok</h4>
          <p id="totalGroups">0</p>
        </div>
        <div class="card">
          <h4>Slot Tersedia</h4>
          <p id="slotsFree">0</p>
        </div>
        <div class="card">
          <h4>Slot Terpakai</h4>
          <p id="slotsUsed">0</p>
        </div>
      </div>

      <section id="dashboard" style="margin-top:18px">
        <div class="panel">
          <div class="panel-left">
            <div class="card">
              <h4>Komposisi Kelompok</h4>
              <div style="margin-top:12px; overflow:auto">
                <table id="groupsTable">
                  <thead>
                    <tr><th>Kelompok</th><th>Kapasitas</th><th>Terisi</th><th>Sisa</th><th>Status</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4>Grafik Ringkasan (Slot terisi per kelompok)</h4>
              <div class="chart-box"><canvas id="barChart" width="600" height="220"></canvas></div>
            </div>
          </div>

          <div class="panel-right">
            <div class="card">
              <h4>Pengaturan Cepat</h4>
              <div style="margin-top:8px; display:flex; flex-direction:column; gap:8px">
                <div class="form-row">
                  <label style="width:140px">Jumlah Kelompok</label>
                  <input id="quickGroups" type="number" class="input" value="5" min="1">
                </div>

                <div class="form-row">
                  <label style="width:140px">Kapasitas per Kelompok</label>
                  <input id="quickCap" type="number" class="input" value="5" min="1">
                </div>

                <div style="display:flex; gap:8px">
                  <button class="btn" onclick="applyQuickSettings()">Simpan Pengaturan</button>
                  <button class="btn ghost" onclick="autoBalance()">Auto Balance Preview</button>
                </div>

                <div id="quickNote" style="font-size:13px; color:var(--muted)"></div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h4>Log Aktivitas Singkat</h4>
              <div id="logBox" style="max-height:260px; overflow:auto; font-size:13px; color:var(--muted)"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- setup -->
      <section id="setup" style="display:none; margin-top:18px">
        <div class="card">
          <h4>Buat Session Baru / Edit</h4>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px">
            <div class="form-row">
              <label style="width:160px">Nama Kelompok (prefix)</label>
              <input id="groupPrefix" class="input" value="Kelompok">
            </div>

            <div class="form-row">
              <label style="width:160px">Jumlah Kelompok</label>
              <input id="numGroups" type="number" class="input" value="10" min="1">
            </div>

            <div class="form-row">
              <label style="width:160px">Kapasitas per Kelompok</label>
              <input id="capGroups" type="number" class="input" value="5" min="1">
            </div>

            <div style="display:flex; gap:8px; margin-top:6px">
              <button class="btn" onclick="createNewSession()">Buat Session Baru</button>
              <button class="btn ghost" onclick="fetchSummary()">Refresh Status</button>
            </div>

            <div id="setupNote" style="font-size:13px; color:var(--muted)"></div>
          </div>
        </div>
      </section>

      <!-- logs -->
      <section id="logs" style="display:none; margin-top:18px">
        <div class="card">
          <h4>Semua Log</h4>
          <div id="allLogs" style="max-height:420px; overflow:auto; font-size:13px; color:var(--muted)"></div>
        </div>
      </section>

      <footer>Admin Dashboard • Kelompok Online — Buat oleh kamu • Realtime via Socket.io</footer>
    </main>
  </div>

  <script>
    // ====== koneksi Socket.io ======
    const socket = io('http://localhost:3000');
    const logBox = document.getElementById('logBox');
    const allLogs = document.getElementById('allLogs');

    let SESSION = { groups: [] };
    let logs = [];

    function pushLog(text){
      const ts = new Date().toLocaleTimeString();
      logs.unshift(`[${ts}] ${text}`);
      if(logs.length>200) logs.pop();
      logBox.innerHTML = logs.slice(0,30).map(l => `<div>${l}</div>`).join('');
      allLogs.innerHTML = logs.map(l => `<div>${l}</div>`).join('');
    }

    socket.on('connect', ()=>{
      document.getElementById('serverStatus').innerText = 'online';
      pushLog('Socket connected: '+socket.id);
    });

    socket.on('disconnect', ()=>{
      document.getElementById('serverStatus').innerText = 'offline';
      pushLog('Socket disconnected');
    });

    socket.on('session_update', (s) => {
      SESSION = s;
      pushLog('Session updated');
      renderSummary();
      renderChart();
    });

    // initial fetch in case socket missed
    fetch('/api/session').then(r=>r.json()).then(s=>{ SESSION=s; renderSummary(); renderChart(); pushLog('Initial load from API'); }).catch(()=>{});

    // ====== render functions ======
    function renderSummary(){
      const tbody = document.querySelector('#groupsTable tbody');
      tbody.innerHTML = '';

      let totalMembers = 0;
      let totalCap = 0;

      SESSION.groups.forEach((g, idx) => {
        const terisi = g.members.length;
        const sisa = g.capacity - terisi;
        const status = terisi >= g.capacity ? 'Penuh' : (terisi === 0 ? 'Kosong' : 'Tersedia');

        totalMembers += terisi;
        totalCap += g.capacity;

        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="vertical-align:top">
                          <strong>${g.name || ('Kelompok '+(idx+1))}</strong>
                          <div class="muted" style="font-size:12px; margin-top:6px">Anggota:</div>
                          <ul class="members">
                            ${g.members.map(m => `
                              <li>
                                <span class="member-name">${escapeHtml(m.name)}</span>
                                <div style="display:flex; gap:6px;">
                                  <button class="member-remove" title="Hapus anggota" onclick="removeMember('${g.id}','${m.id}')">Hapus</button>
                                </div>
                              </li>`).join('')}
                          </ul>
                        </td>
                        <td style="vertical-align:top">${g.capacity}</td>
                        <td style="vertical-align:top">${terisi}</td>
                        <td style="vertical-align:top">${sisa}</td>
                        <td style="vertical-align:top"><span class="status-pill ${terisi>=g.capacity? 'pill-full':'pill-ok'}">${status}</span></td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('totalMembers').innerText = totalMembers;
      document.getElementById('totalGroups').innerText = SESSION.groups.length;
      const used = totalMembers;
      document.getElementById('slotsUsed').innerText = used;
      document.getElementById('slotsFree').innerText = ( (SESSION.groups.reduce((a,b)=>a+b.capacity,0)) - used );

      // quick note
      document.getElementById('quickNote').innerText = `Total kapasitas: ${totalCap}. Rata-rata anggota per kelompok: ${ (SESSION.groups.length? (totalMembers/SESSION.groups.length).toFixed(2):0) }`;
    }

    // ====== simple bar chart (canvas) ======
    const canvas = document.getElementById('barChart');
    const ctx = canvas.getContext('2d');

    function renderChart(){
      const labels = SESSION.groups.map(g=>g.name||'G');
      const values = SESSION.groups.map(g=>g.members.length);

      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const w = canvas.width; const h = canvas.height; const padding = 24;
      const maxVal = Math.max(1, ...values);
      const barW = (w - padding*2) / Math.max(SESSION.groups.length,1) * 0.7;

      values.forEach((v,i)=>{
        const x = padding + i*((w-padding*2)/SESSION.groups.length) + ((w- padding*2)/SESSION.groups.length - barW)/2;
        const barH = (v / maxVal) * (h - padding*2);
        const y = h - padding - barH;

        // bar background
        ctx.fillStyle = '#e6eefc';
        roundRect(ctx, x-2, padding, barW+4, h-padding*2, 6);
        ctx.fill();

        // bar
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
        roundRect(ctx, x, y, barW, barH, 6);
        ctx.fill();

        // label
        ctx.fillStyle = '#0f172a';
        ctx.font = '12px system-ui';
        ctx.fillText(values[i], x + barW/2 - 6, y - 8);
        ctx.fillText(labels[i], x, h - 6);
      });
    }

    function roundRect(ctx, x, y, w, h, r){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    // ====== admin actions ======
    function applyQuickSettings(){
      const g = Number(document.getElementById('quickGroups').value);
      const c = Number(document.getElementById('quickCap').value);
      if (!g || !c) return alert('Isi jumlah kelompok dan kapasitas dengan nilai yang valid.');

      // build groups array
      const groups = Array.from({length:g}, (_,i)=>({ name: `Kelompok ${i+1}`, capacity: c }));

      fetch('/api/create-session', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({groupCount:g, capacity:c})})
        .then(r=>r.json()).then(()=>{ pushLog('Session dibuat/diupdate oleh admin (quick)'); fetchSummary(); })
        .catch(e=>pushLog('Error create session: '+e.message));
    }

    function createNewSession(){
      const prefix = document.getElementById('groupPrefix').value || 'Kelompok';
      const n = Number(document.getElementById('numGroups').value);
      const cap = Number(document.getElementById('capGroups').value);
      if(n<1 || cap<1) return alert('Jumlah kelompok & kapasitas harus >=1');

      // server accepts groupCount & capacity
      fetch('/api/create-session', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({groupCount:n, capacity:cap})})
        .then(r=>r.json()).then(()=>{ pushLog('Session baru dibuat oleh admin'); fetchSummary(); })
        .catch(e=>pushLog('Error create session: '+e.message));
    }

    function resetMembers(){
      if(!confirm('Reset semua anggota? (tidak bisa dibatalkan)')) return;
      fetch('/api/reset-members', {method:'POST'})
        .then(r=>r.json()).then(()=>{ pushLog('Semua anggota direset oleh admin'); fetchSummary(); })
        .catch(e=>pushLog('Error reset members: '+e.message));
    }

    function fetchSummary(){
      fetch('/api/session')
        .then(r=>{
          if(!r.ok) throw new Error('Fetch session failed');
          return r.json();
        })
        .then(s=>{ SESSION=s; renderSummary(); renderChart(); pushLog('Summary di-refresh'); })
        .catch(e=>{ pushLog('Error fetch /api/session: '+e.message); });
    }

    function autoBalance(){
      const total = SESSION.groups.reduce((a,b)=>a+b.members.length,0);
      const n = SESSION.groups.length;
      if(n===0) return alert('Belum ada kelompok');
      const base = Math.floor(total/n);
      const extra = total % n;
      let note = `Total anggota: ${total}. Rata-rata ≈ ${ (total/n).toFixed(2) }\n`;
      note += `Saran: ${extra} kelompok akan berisi ${base+1} anggota, sisanya ${base}.`;
      alert(note);
    }

    // REMOVE MEMBER API
    function removeMember(groupId, memberId){
      if(!confirm('Yakin menghapus anggota ini dari kelompok?')) return;
      fetch('/api/remove-member', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ groupId, memberId })
      })
      .then(r=>r.json())
      .then(data=>{
        if(data && data.success){
          pushLog(`Member ${memberId} dihapus dari ${groupId}`);
        } else {
          pushLog('Gagal menghapus member: '+(data && data.error ? data.error : 'unknown'));
          alert('Gagal menghapus anggota');
        }
      })
      .catch(e=>{ pushLog('Error remove-member: '+e.message); alert('Error menghapus anggota'); });
    }

    // helper nav
    function show(id){
      document.querySelectorAll('main section').forEach(s=>s.style.display='none');
      const el = document.getElementById(id);
      if(el) el.style.display='block';
      document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
      // find clicked button and set active (use event from onclick)
      try{
        event.target.classList.add('active');
      }catch(e){}
    }

    // theme toggle (simple)
    function toggleTheme(){
      document.body.classList.toggle('dark');
      if(document.body.classList.contains('dark')){
        document.documentElement.style.setProperty('--card-bg','#0b1220');
        document.documentElement.style.setProperty('--muted','#94a3b8');
        document.documentElement.style.setProperty('--shadow','0 6px 18px rgba(2,6,23,0.6)');
        document.documentElement.style.setProperty('--primary','#60a5fa');
      } else {
        document.documentElement.style.setProperty('--card-bg','#ffffff');
        document.documentElement.style.setProperty('--muted','#6b7280');
        document.documentElement.style.setProperty('--shadow','0 6px 18px rgba(30,58,138,0.08)');
        document.documentElement.style.setProperty('--primary','#3B82F6');
      }
      renderChart();
    }

    // small escape helper to avoid XSS in names
    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
    }

    // initial
    fetchSummary();
  </script>
</body>
</html>
